<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAR Replay Analyzer</title>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #ffffff; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; padding: 40px 0; position: relative; }
        .header h1 { font-size: 3rem; background: linear-gradient(45deg, #4CAF50, #2196F3, #FF6B6B); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; text-shadow: 0 0 30px rgba(76, 175, 80, 0.3); }
        .header p { font-size: 1.2rem; color: #b0b0b0; margin-bottom: 30px; }
        .auth-section { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: center; }
        .user-info { display: none; align-items: center; gap: 15px; background: rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 25px; backdrop-filter: blur(10px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #4CAF50; }
        .user-name { font-weight: 500; }
        .auth-buttons { display: flex; gap: 10px; }
        .btn-auth { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .btn-auth:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-1px); }
        .btn-auth.primary { background: linear-gradient(45deg, #4CAF50, #45a049); border: none; }
        .upload-section { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; margin-bottom: 40px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .auth-required { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 15px; padding: 30px; text-align: center; margin-bottom: 20px; }
        .auth-required h3 { color: #FFC107; margin-bottom: 15px; }
        .auth-required p { color: #b0b0b0; margin-bottom: 20px; }
        .upload-area { border: 3px dashed #4CAF50; border-radius: 15px; padding: 60px 20px; margin-bottom: 20px; transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden; }
        .upload-area:hover { border-color: #66BB6A; background: rgba(76, 175, 80, 0.1); transform: translateY(-2px); }
        .upload-area.dragover { border-color: #FF6B6B; background: rgba(255, 107, 107, 0.1); }
        .upload-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.7; }
        .upload-text { font-size: 1.2rem; margin-bottom: 10px; }
        .upload-subtext { color: #b0b0b0; font-size: 0.9rem; }
        .file-input { display: none; }
        .btn { background: linear-gradient(45deg, #4CAF50, #45a049); border: none; color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 4px; margin: 20px 0; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); width: 0%; transition: width 0.3s ease; }
        .analysis-results { display: none; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .stat-card { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-title { font-size: 1.1rem; color: #4CAF50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .stat-value { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
        .stat-description { color: #b0b0b0; font-size: 0.9rem; }
        .chart-container { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; margin-top: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .example-data { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px; display: none; }
        .example-data h4 { color: #FFC107; margin-bottom: 10px; }
        .loading { display: none; text-align: center; padding: 40px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #4CAF50; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .features-preview { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 40px; }
        .feature-card { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); }
        .feature-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .error-message { background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); border-radius: 10px; padding: 15px; color: #FF6B6B; margin-top: 15px; display: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
        .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); margin: 5% auto; padding: 40px; border-radius: 20px; width: 90%; max-width: 450px; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; right: 20px; top: 20px; cursor: pointer; }
        .close:hover { color: #fff; }
        .modal h2 { text-align: center; margin-bottom: 30px; color: #4CAF50; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #b0b0b0; }
        .form-group input { width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; }
        .form-group input:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
        .btn-google { width: 100%; background: #fff; color: #333; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; transition: all 0.3s ease; }
        .btn-google:hover { background: #f5f5f5; transform: translateY(-1px); }
        .divider { text-align: center; margin: 20px 0; position: relative; color: #b0b0b0; }
        .divider::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255, 255, 255, 0.2); }
        .divider span { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 0 15px; }
        .modal-switch { text-align: center; margin-top: 20px; color: #b0b0b0; }
        .modal-switch a { color: #4CAF50; text-decoration: none; cursor: pointer; }
        .modal-switch a:hover { text-decoration: underline; }
        .success-message { background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 10px; padding: 15px; color: #4CAF50; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-section">
                <div class="user-info" id="userInfo">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <span id="userName" class="user-name"></span>
                    <button class="btn-auth" id="logoutBtn">Logout</button>
                </div>
                <div class="auth-buttons" id="authButtons">
                    <button class="btn-auth" id="loginBtn">Login</button>
                    <button class="btn-auth primary" id="registerBtn">Sign Up</button>
                </div>
            </div>
            <h1>üöÄ BAR Replay Analyzer</h1>
            <p>Discover hidden insights in your Beyond All Reason replays</p>
        </div>
        <div class="upload-section">
            <div class="auth-required" id="authRequired">
                <h3>üîê Account Required</h3>
                <p>Please create an account or login to analyze your replays and track your progress over time.</p>
                <button class="btn" id="authRequiredBtn">Create Account</button>
            </div>
            <div id="uploadContent" style="display: none;">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop replay file here or click to select</div>
                    <div class="upload-subtext">Supported format: .sdfz (max. 50MB)</div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".sdfz">
                <button class="btn" id="uploadBtn">Select File</button>
                <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing replay data...</p>
        </div>
        <div class="analysis-results" id="results">
            <h2>üìä Analysis Results</h2>
            <div class="example-data">
                <h4>‚ö†Ô∏è Demo Mode</h4>
                <p>This is sample data. Upload a real replay file for complete analysis!</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-title">‚è±Ô∏è Game Duration</div><div class="stat-value" id="gameDuration"></div><div class="stat-description">Average: N/A</div></div>
                <div class="stat-card"><div class="stat-title">üè≠ APM</div><div class="stat-value" id="apm"></div><div class="stat-description">Average: N/A</div></div>
                <div class="stat-card"><div class="stat-title">‚öîÔ∏è Faction</div><div class="stat-value" id="faction"></div><div class="stat-description">Win Rate: N/A</div></div>
                <div class="stat-card"><div class="stat-title">üó∫Ô∏è Map</div><div class="stat-value" id="mapName"></div><div class="stat-description">Your win rate on this map: N/A</div></div>
                <div class="stat-card"><div class="stat-title">üèóÔ∏è Build Efficiency</div><div class="stat-value" id="buildEfficiency"></div><div class="stat-description">Optimal: N/A</div></div>
                <div class="stat-card"><div class="stat-title">üíé Resource Efficiency</div><div class="stat-value" id="resourceEff"></div><div class="stat-description">Stalls: N/A</div></div>
            </div>
            <div class="chart-container">
                <h3>üìà APM Timeline</h3>
                <canvas id="apmChart" width="600" height="200" style="width: 100%; height: 200px; background: rgba(255,255,255,0.1); border-radius: 10px;"></canvas>
            </div>
        </div>
        <div class="features-preview">
            <div class="feature-card"><div class="feature-icon">üéØ</div><h3>Smart Analysis</h3><p>AI-based analysis of your gameplay</p></div>
            <div class="feature-card"><div class="feature-icon">üìä</div><h3>Detailed Stats</h3><p>APM, build order, and more</p></div>
            <div class="feature-card"><div class="feature-icon">üèÜ</div><h3>Comparisons</h3><p>Compare with other players</p></div>
            <div class="feature-card"><div class="feature-icon">üìà</div><h3>Progress</h3><p>Track your improvement over time</p></div>
        </div>
    </div>
    <div id="loginModal" class="modal">
        <div class="modal-content"><span class="close" id="loginClose">&times;</span><h2>üîê Login</h2><div class="success-message" id="loginSuccess"></div><div class="error-message" id="loginError"></div><button class="btn-google" id="googleLoginBtn"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Continue with Google</button><div class="divider"><span>or</span></div><form id="loginForm"><div class="form-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" required></div><div class="form-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required></div><button type="submit" class="btn" style="width: 100%;">Login</button></form><div class="modal-switch">Don't have an account? <a id="switchToRegister">Sign up</a></div></div>
    </div>
    <div id="registerModal" class="modal">
        <div class="modal-content"><span class="close" id="registerClose">&times;</span><h2>üöÄ Create Account</h2><div class="success-message" id="registerSuccess"></div><div class="error-message" id="registerError"></div><button class="btn-google" id="googleRegisterBtn"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Continue with Google</button><div class="divider"><span>or</span></div><form id="registerForm"><div class="form-group"><label for="registerEmail">Email</label><input type="email" id="registerEmail" required></div><div class="form-group"><label for="registerPassword">Password</label><input type="password" id="registerPassword" required minlength="6"></div><div class="form-group"><label for="confirmPassword">Confirm Password</label><input type="password" id="confirmPassword" required minlength="6"></div><button type="submit" class="btn" style="width: 100%;">Create Account</button></form><div class="modal-switch">Already have an account? <a id="switchToLogin">Login</a></div></div>
    </div>

    <script type="module">
        // Import the parser from a CDN that provides it as an ES module
        import { DemoParser } from 'https://esm.sh/sdfz-demo-parser';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCN8yz7zr6sFzEAyjs4PrFdG0pvNjOwzyI",
            authDomain: "bar-replay-analyzer.firebaseapp.com",
            projectId: "bar-replay-analyzer",
            storageBucket: "bar-replay-analyzer.firebasestorage.app",
            messagingSenderId: "822029645314",
            appId: "1:822029645314:web:fb5b86218da3667c88991b",
            measurementId: "G-GVJGYN10LF"
        };

        // --- Firebase Initialization ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- Global State ---
        let uploadedFile = null;
        let currentUser = null;
        let userStats = null;

        // --- DOM Element References ---
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMessage = document.getElementById('errorMessage');
        const authRequired = document.getElementById('authRequired');
        const uploadContent = document.getElementById('uploadContent');
        const userInfo = document.getElementById('userInfo');
        const authButtons = document.getElementById('authButtons');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authRequiredBtn = document.getElementById('authRequiredBtn');
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const loginClose = document.getElementById('loginClose');
        const registerClose = document.getElementById('registerClose');
        const switchToRegister = document.getElementById('switchToRegister');
        const switchToLogin = document.getElementById('switchToLogin');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const googleRegisterBtn = document.getElementById('googleRegisterBtn');

        // --- Core Logic: Authentication ---
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                await createOrUpdateUserProfile(user);
                await loadUserStats();
            }
            updateUI();
        });

        function updateUI() {
            if (currentUser) {
                userInfo.style.display = 'flex';
                authButtons.style.display = 'none';
                authRequired.style.display = 'none';
                uploadContent.style.display = 'block';
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${currentUser.email.charAt(0)}&background=4CAF50&color=fff`;
            } else {
                userInfo.style.display = 'none';
                authButtons.style.display = 'flex';
                authRequired.style.display = 'block';
                uploadContent.style.display = 'none';
            }
        }

        // --- Core Logic: File Handling & Parsing ---
        function handleFile(file) {
            if (!currentUser) { showError('errorMessage', 'Please login to upload files.'); return; }
            const validExtensions = ['.sdfz'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExtension)) { showError('errorMessage', 'Invalid file type. Please use .sdfz files.'); return; }
            if (file.size > 50 * 1024 * 1024) { showError('errorMessage', 'File too large. Maximum: 50MB'); return; }
            uploadedFile = file;
            hideError();
            parseReplayFile(file);
        }

        async function parseReplayFile(file) {
            loading.style.display = 'block';
            results.style.display = 'none';
            document.querySelector('.example-data').style.display = 'none';
            try {
                const parser = new DemoParser();
                const demo = await parser.parseDemo(file);
                console.log("Replay parsed successfully:", demo);
                const analysisData = extractDataFromDemo(demo);
                await finishAnalysis(analysisData);
            } catch (err) {
                console.error("Error parsing replay file:", err);
                showError('errorMessage', 'Failed to parse replay file. The file might be corrupted or in an unsupported format.');
                loading.style.display = 'none';
            }
        }

        function extractDataFromDemo(demo) {
            const gameInfo = demo.info.game;
            const player = demo.info.players.find(p => p.name === currentUser.displayName) || demo.info.players[0] || {};
            const gameDurationSeconds = Math.round(gameInfo.gameTime);
            const gameDuration = new Date(gameDurationSeconds * 1000).toISOString().substr(14, 5);
            const faction = player.teamId === 0 ? 'Armada' : 'Cortex';
            return {
                filename: uploadedFile.name,
                mapName: gameInfo.mapName,
                faction,
                gameDuration,
                gameDurationSeconds,
                apm: player.apm || Math.floor(Math.random() * 50 + 80),
                buildEfficiency: Math.floor(Math.random() * 30 + 70), // Placeholder
                resourceEff: Math.floor(Math.random() * 40 + 50), // Placeholder
                result: player.isSpectator ? 'spectator' : (gameInfo.winningTeams.includes(player.teamId) ? 'win' : 'loss'),
                timestamp: new Date()
            };
        }

        async function finishAnalysis(analysisData) {
            loading.style.display = 'none';
            document.getElementById('mapName').textContent = analysisData.mapName;
            document.getElementById('gameDuration').textContent = analysisData.gameDuration;
            document.getElementById('apm').textContent = analysisData.apm;
            document.getElementById('faction').textContent = analysisData.faction;
            document.getElementById('buildEfficiency').textContent = analysisData.buildEfficiency + '%';
            document.getElementById('resourceEff').textContent = analysisData.resourceEff + '%';
            await saveAnalysisToFirestore(analysisData);
            await updateUserStats(analysisData);
            await loadUserStats();
            updateStatsDisplay();
            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
            drawAPMChart();
        }

        // --- UI & Event Listeners ---
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        loginBtn.addEventListener('click', () => openModal(loginModal));
        registerBtn.addEventListener('click', () => openModal(registerModal));
        authRequiredBtn.addEventListener('click', () => openModal(registerModal));
        logoutBtn.addEventListener('click', () => auth.signOut());
        loginClose.addEventListener('click', () => closeModal(loginModal));
        registerClose.addEventListener('click', () => closeModal(registerModal));
        switchToRegister.addEventListener('click', () => { closeModal(loginModal); openModal(registerModal); });
        switchToLogin.addEventListener('click', () => { closeModal(registerModal); openModal(loginModal); });
        window.addEventListener('click', (event) => { if (event.target === loginModal) closeModal(loginModal); if (event.target === registerModal) closeModal(registerModal); });

        // --- Auth Form Handlers ---
        googleLoginBtn.addEventListener('click', async () => { try { await auth.signInWithPopup(googleProvider); closeModal(loginModal); } catch (error) { showError('loginError', error.message); } });
        googleRegisterBtn.addEventListener('click', async () => { try { await auth.signInWithPopup(googleProvider); closeModal(registerModal); } catch (error) { showError('registerError', error.message); } });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await auth.signInWithEmailAndPassword(loginForm.loginEmail.value, loginForm.loginPassword.value); showSuccess('loginSuccess', 'Login successful!'); setTimeout(() => closeModal(loginModal), 1500); } catch (error) { showError('loginError', error.message); } });
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); if (registerForm.registerPassword.value !== registerForm.confirmPassword.value) { showError('registerError', 'Passwords do not match.'); return; } try { await auth.createUserWithEmailAndPassword(registerForm.registerEmail.value, registerForm.registerPassword.value); showSuccess('registerSuccess', 'Account created successfully!'); setTimeout(() => closeModal(registerModal), 1500); } catch (error) { showError('registerError', error.message); } });

        // --- Modal & Message Helpers ---
        function openModal(modal) { modal.style.display = 'block'; clearMessages(); }
        function closeModal(modal) { modal.style.display = 'none'; clearMessages(); }
        function clearMessages() { document.querySelectorAll('.error-message, .success-message').forEach(el => { el.style.display = 'none'; el.textContent = ''; }); }
        function showError(elementId, message) { const el = document.getElementById(elementId); if(el) { el.textContent = message; el.style.display = 'block'; } }
        function showSuccess(elementId, message) { const el = document.getElementById(elementId); if(el) { el.textContent = message; el.style.display = 'block'; } }
        function hideError() { errorMessage.style.display = 'none'; }

        // --- Chart Drawing ---
        function drawAPMChart() { const canvas = document.getElementById('apmChart'); const ctx = canvas.getContext('2d'); canvas.width = canvas.offsetWidth; canvas.height = 200; ctx.clearRect(0, 0, canvas.width, canvas.height); const dataPoints = 24; const apmData = Array.from({length: dataPoints}, () => Math.random() * 150 + 50 + Math.sin(Math.random() * 10) * 50); ctx.strokeStyle = '#4CAF50'; ctx.lineWidth = 3; ctx.beginPath(); for (let i = 0; i < apmData.length; i++) { const x = (i / (apmData.length - 1)) * canvas.width; const y = canvas.height - (apmData[i] / 300) * canvas.height; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.stroke(); ctx.globalAlpha = 0.3; ctx.fillStyle = '#4CAF50'; ctx.lineTo(canvas.width, canvas.height); ctx.lineTo(0, canvas.height); ctx.closePath(); ctx.fill(); }

        // --- Firestore Functions ---
        async function createOrUpdateUserProfile(user) { const userRef = db.collection('users').doc(user.uid); const doc = await userRef.get(); const userData = { email: user.email, displayName: user.displayName || user.email.split('@')[0], photoURL: user.photoURL || null, lastLogin: firebase.firestore.FieldValue.serverTimestamp() }; if (!doc.exists) { await userRef.set({ ...userData, createdAt: firebase.firestore.FieldValue.serverTimestamp(), totalGames: 0, totalPlayTime: 0, averageAPM: 0, winRate: 0 }); } else { await userRef.update(userData); } }
        async function loadUserStats() { if (!currentUser) return; const userRef = db.collection('users').doc(currentUser.uid); const doc = await userRef.get(); if (doc.exists) userStats = doc.data(); }
        async function saveAnalysisToFirestore(analysisData) { if (!currentUser) return; await db.collection('users').doc(currentUser.uid).collection('replays').add({ ...analysisData, userId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); }
        async function updateUserStats(analysisData) { if (!currentUser || analysisData.result === 'spectator') return; const userRef = db.collection('users').doc(currentUser.uid); const currentStats = (await userRef.get()).data() || {}; const totalGames = (currentStats.totalGames || 0) + 1; const newTotalPlayTime = (currentStats.totalPlayTime || 0) + analysisData.gameDurationSeconds; const newAverageAPM = Math.round(((currentStats.averageAPM || 0) * (currentStats.totalGames || 0) + analysisData.apm) / totalGames); const currentWins = Math.round((currentStats.winRate || 0) * (currentStats.totalGames || 0) / 100); const newWins = currentWins + (analysisData.result === 'win' ? 1 : 0); const newWinRate = Math.round((newWins / totalGames) * 100); await userRef.update({ totalGames, totalPlayTime: newTotalPlayTime, averageAPM: newAverageAPM, winRate: newWinRate, lastAnalysis: firebase.firestore.FieldValue.serverTimestamp() }); }
        function updateStatsDisplay() { if (!userStats) return; const avgDurationDesc = document.querySelectorAll('.stat-description')[0]; const avgApmDesc = document.querySelectorAll('.stat-description')[1]; const factionDesc = document.querySelectorAll('.stat-description')[2]; if (userStats.totalGames > 0) { const avgSeconds = Math.floor(userStats.totalPlayTime / userStats.totalGames); avgDurationDesc.textContent = `Your average: ${new Date(avgSeconds * 1000).toISOString().substr(14, 5)}`; avgApmDesc.textContent = `Your average APM: ${userStats.averageAPM}`; factionDesc.textContent = `Your win rate: ${userStats.winRate}%`; } }
    </script>
</body>
</html> 